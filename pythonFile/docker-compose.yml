# docker-compose.yml
services:
  rtsp-server:
    image: bluenviron/mediamtx
    container_name: rtsp-server
    ports:
      - "46458:8554" 
    restart: always

  ffmpeg-relay:
    image: jrottenberg/ffmpeg:4.4-ubuntu
    container_name: ffmpeg-relay
    depends_on:
      - rtsp-server
    volumes:
      - ../sampleTest/vid_test_1.mp4:/videos/vid_test_1.mp4:ro
      - ../sampleTest/vid_test_2.mp4:/videos/vid_test_2.mp4:ro
    restart: always
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "ffmpeg -re -stream_loop -1 -err_detect ignore_err -i /videos/vid_test_1.mp4 -c:v libx264 -preset ultrafast -tune zerolatency -f rtsp rtsp://rtsp-server:8554/mystream1
      & ffmpeg -re -stream_loop -1 -err_detect ignore_err -i /videos/vid_test_2.mp4 -c:v libx264 -preset ultrafast -tune zerolatency -f rtsp rtsp://rtsp-server:8554/mystream2
      && wait"
  
  db:
    image: mysql:9.4 
    container_name: mysql_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: 12345
      MYSQL_DATABASE: rtsp_db
    ports:
      - "3306:3306" # Dùng cổng chuẩn 3306
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p12345"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build: . 
    container_name: face_recognition_app
    depends_on:
      rtsp-server:
        condition: service_started
      db:
        condition: service_healthy # Đợi DB sẵn sàng
    ports:
      - "8000:8000"
    volumes:
      - .:/app  
    working_dir: /app 
    command: python -m Realtime_running.server
    
    # Kích hoạt GPU (nếu có)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]